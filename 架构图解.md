# Conditional Tokens æ¶æ„å›¾è§£ ğŸ“

> é€šè¿‡å¯è§†åŒ–å›¾è¡¨ç†è§£ç³»ç»Ÿæ¶æ„

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç•Œé¢å±‚                              â”‚
â”‚  (Web3 DApp / é¢„æµ‹å¸‚åœºå‰ç«¯ / äº¤æ˜“ç•Œé¢)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ConditionalTokens åˆçº¦                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ERC1155 (å¤šä»£å¸æ ‡å‡†)                              â”‚   â”‚
â”‚  â”‚  - balanceOf()                                   â”‚   â”‚
â”‚  â”‚  - safeTransferFrom()                            â”‚   â”‚
â”‚  â”‚  - balanceOfBatch()                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ ¸å¿ƒåŠŸèƒ½                                          â”‚   â”‚
â”‚  â”‚  - prepareCondition()      å‡†å¤‡æ¡ä»¶                â”‚   â”‚
â”‚  â”‚  - reportPayouts()         æŠ¥å‘Šç»“æœ                â”‚   â”‚
â”‚  â”‚  - splitPosition()         åˆ†å‰²ä½ç½®                â”‚   â”‚
â”‚  â”‚  - mergePositions()        åˆå¹¶ä½ç½®                â”‚   â”‚
â”‚  â”‚  - redeemPositions()       èµå›ä½ç½®                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CTHelpers åº“                           â”‚
â”‚  - getConditionId()      è®¡ç®—æ¡ä»¶ID                      â”‚
â”‚  - getCollectionId()     è®¡ç®—é›†åˆID (æ¤­åœ†æ›²çº¿)            â”‚
â”‚  - getPositionId()       è®¡ç®—ä½ç½®ID                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤–éƒ¨ä¾èµ–                                      â”‚
â”‚  - ERC20 æŠµæŠ¼ä»£å¸ (DAI, USDC, etc.)                      â”‚
â”‚  - é¢„è¨€æœº (Reality.eth, Chainlink, etc.)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å®Œæ•´ç”Ÿå‘½å‘¨æœŸæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å‡†å¤‡é˜¶æ®µ  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  prepareCondition()
       â”‚
       â”œâ”€ è¾“å…¥: oracle, questionId, outcomeSlotCount
       â”œâ”€ ç”Ÿæˆ: conditionId
       â””â”€ åˆå§‹åŒ–: payoutNumerators[conditionId] = [0, 0, ..., 0]
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. åˆ†å‰²é˜¶æ®µ  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  ç”¨æˆ·æˆæƒ ERC20
       â”‚
       â–¼
  splitPosition()
       â”‚
       â”œâ”€ é”å®šæŠµæŠ¼ä»£å¸
       â”œâ”€ è®¡ç®— positionIds
       â””â”€ é“¸é€  ERC1155 ä»£å¸
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. äº¤æ˜“é˜¶æ®µ  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  ERC1155 è½¬è´¦
       â”‚
       â”œâ”€ safeTransferFrom()
       â””â”€ å¸‚åœºäº¤æ˜“
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. è§£å†³é˜¶æ®µ  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  reportPayouts()
       â”‚
       â”œâ”€ è¾“å…¥: payouts = [1, 0, 0]
       â”œâ”€ è®¾ç½®: payoutNumerators[conditionId] = [1, 0, 0]
       â””â”€ è®¾ç½®: payoutDenominator[conditionId] = 1
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. èµå›é˜¶æ®µ  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  redeemPositions()
       â”‚
       â”œâ”€ è®¡ç®—æ”¯ä»˜é‡‘é¢
       â”œâ”€ é”€æ¯ ERC1155 ä»£å¸
       â””â”€ è½¬å‡ºæŠµæŠ¼ä»£å¸
       â”‚
       â–¼
     å®Œæˆ
```

---

## ğŸ¯ æ¡ä»¶å’Œä½ç½®çš„å…³ç³»

```
æ¡ä»¶ (Condition)
â”œâ”€ conditionId = hash(oracle, questionId, outcomeSlotCount)
â”œâ”€ ç»“æœæ§½: [A, B, C, D]
â”‚
â””â”€ å¯èƒ½çš„é›†åˆ (Collections)
    â”œâ”€ å•ä¸ªç»“æœ
    â”‚   â”œâ”€ A (0b0001)
    â”‚   â”œâ”€ B (0b0010)
    â”‚   â”œâ”€ C (0b0100)
    â”‚   â””â”€ D (0b1000)
    â”‚
    â”œâ”€ ä¸¤ä¸ªç»“æœç»„åˆ
    â”‚   â”œâ”€ A|B (0b0011)
    â”‚   â”œâ”€ A|C (0b0101)
    â”‚   â”œâ”€ A|D (0b1001)
    â”‚   â”œâ”€ B|C (0b0110)
    â”‚   â”œâ”€ B|D (0b1010)
    â”‚   â””â”€ C|D (0b1100)
    â”‚
    â”œâ”€ ä¸‰ä¸ªç»“æœç»„åˆ
    â”‚   â”œâ”€ A|B|C (0b0111)
    â”‚   â”œâ”€ A|B|D (0b1011)
    â”‚   â”œâ”€ A|C|D (0b1101)
    â”‚   â””â”€ B|C|D (0b1110)
    â”‚
    â””â”€ æ‰€æœ‰ç»“æœ
        â””â”€ A|B|C|D (0b1111)

æ¯ä¸ªé›†åˆ + æŠµæŠ¼ä»£å¸ = ä¸€ä¸ªä½ç½® (Position)
positionId = hash(collateralToken, collectionId)
```

---

## ğŸ’° åˆ†å‰²å’Œåˆå¹¶æœºåˆ¶

### å®Œæ•´åˆ†å‰²ï¼ˆä»æŠµæŠ¼å“ï¼‰

```
è¾“å…¥: 100 DAI

splitPosition(DAI, 0x00, conditionId, [0b01, 0b10], 100)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   100 DAI   â”‚  â† é”å®šåœ¨åˆçº¦ä¸­
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼             â–¼             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 100 ä¸ª  â”‚  â”‚ 100 ä¸ª  â”‚  â”‚ 100 ä¸ª  â”‚
  â”‚ ä½ç½® A  â”‚  â”‚ ä½ç½® B  â”‚  â”‚ ä½ç½® C  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   (0b001)      (0b010)      (0b100)
```

### éƒ¨åˆ†åˆ†å‰²ï¼ˆä»çˆ¶ä½ç½®ï¼‰

```
è¾“å…¥: 100 ä¸ª "A|B" ä½ç½®

splitPosition(DAI, parentId, conditionId, [0b01, 0b10], 100)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  100 ä¸ª A|B  â”‚  â† é”€æ¯
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼          â–¼          â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 100 ä¸ª â”‚  â”‚ 100 ä¸ª â”‚
  â”‚ ä½ç½® A â”‚  â”‚ ä½ç½® B â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆå¹¶ï¼ˆå›åˆ°æŠµæŠ¼å“ï¼‰

```
è¾“å…¥: 100ä¸ªä½ç½®A + 100ä¸ªä½ç½®B + 100ä¸ªä½ç½®C

mergePositions(DAI, 0x00, conditionId, [0b001, 0b010, 0b100], 100)

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 100 ä¸ª  â”‚  â”‚ 100 ä¸ª  â”‚  â”‚ 100 ä¸ª  â”‚
  â”‚ ä½ç½® A  â”‚  â”‚ ä½ç½® B  â”‚  â”‚ ä½ç½® C  â”‚  â† é”€æ¯
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚            â”‚            â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   100 DAI   â”‚  â† è½¬ç»™ç”¨æˆ·
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¢ æ”¯ä»˜è®¡ç®—ç¤ºä¾‹

### åœºæ™¯ï¼šä¸‰é€‰ä¸€é—®é¢˜

```
é—®é¢˜: "è°ä¼šèµ¢ï¼Ÿ" [é˜Ÿä¼A, é˜Ÿä¼B, é˜Ÿä¼C]
ç»“æœ: é˜Ÿä¼A èµ¢äº†
æ”¯ä»˜å‘é‡: [1, 0, 0]
åˆ†æ¯: 1
```

### ä¸åŒä½ç½®çš„èµå›

```
ä½ç½®ç±»å‹              indexSet    è®¡ç®—è¿‡ç¨‹                èµå›æ¯”ä¾‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åªæœ‰A                0b001       1/1                    100%
åªæœ‰B                0b010       0/1                    0%
åªæœ‰C                0b100       0/1                    0%
Aæˆ–B                 0b011       (1+0)/1 = 1/1         100%
Aæˆ–C                 0b101       (1+0)/1 = 1/1         100%
Bæˆ–C                 0b110       (0+0)/1 = 0/1         0%
æ‰€æœ‰                 0b111       (1+0+0)/1 = 1/1       100%
```

### åœºæ™¯ï¼šéƒ¨åˆ†æ­£ç¡®

```
é—®é¢˜: "å“ªäº›é˜Ÿä¼ä¼šè¿›å…¥å†³èµ›ï¼Ÿ" [A, B, C, D]
ç»“æœ: A å’Œ C è¿›å…¥
æ”¯ä»˜å‘é‡: [1, 0, 1, 0]
åˆ†æ¯: 2
```

```
ä½ç½®ç±»å‹              indexSet    è®¡ç®—è¿‡ç¨‹                èµå›æ¯”ä¾‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åªæœ‰A                0b0001      1/2                    50%
åªæœ‰B                0b0010      0/2                    0%
åªæœ‰C                0b0100      1/2                    50%
åªæœ‰D                0b1000      0/2                    0%
Aå’ŒC                 0b0101      (1+1)/2 = 2/2         100%
Aå’ŒB                 0b0011      (1+0)/2 = 1/2         50%
æ‰€æœ‰                 0b1111      (1+0+1+0)/2 = 2/2     100%
```

---

## ğŸŒ³ åµŒå¥—æ¡ä»¶ç¤ºä¾‹

### åœºæ™¯ï¼šæ¡ä»¶çš„æ¡ä»¶

```
æ¡ä»¶1: "é˜Ÿä¼Aä¼šè¿›å…¥å†³èµ›å—ï¼Ÿ" [æ˜¯, å¦]
æ¡ä»¶2: "å¦‚æœè¿›å…¥å†³èµ›ï¼Œä¼šèµ¢å—ï¼Ÿ" [èµ¢, è¾“]
```

### æ ‘çŠ¶ç»“æ„

```
                    100 DAI (æŠµæŠ¼å“)
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ åˆ†å‰²æ¡ä»¶1                      â”‚
        â–¼                               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Aè¿›å…¥   â”‚                     â”‚ Aæœªè¿›å…¥ â”‚
   â”‚ 100ä¸ª   â”‚                     â”‚ 100ä¸ª   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ åˆ†å‰²æ¡ä»¶2
        â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Aè¿›å…¥ â”‚  â”‚Aè¿›å…¥ â”‚
â”‚ä¸”èµ¢  â”‚  â”‚ä½†è¾“  â”‚
â”‚100ä¸ª â”‚  â”‚100ä¸ª â”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
```

### ä½ç½®å±‚çº§

```
å±‚çº§ 0: æŠµæŠ¼å“ (DAI)
  â””â”€ collectionId = 0x00...00

å±‚çº§ 1: æ¡ä»¶1çš„ç»“æœ
  â”œâ”€ "Aè¿›å…¥" collectionId = getCollectionId(0x00, condition1Id, 0b01)
  â””â”€ "Aæœªè¿›å…¥" collectionId = getCollectionId(0x00, condition1Id, 0b10)

å±‚çº§ 2: æ¡ä»¶2çš„ç»“æœï¼ˆåŸºäº"Aè¿›å…¥"ï¼‰
  â”œâ”€ "Aè¿›å…¥ä¸”èµ¢" collectionId = getCollectionId(collection1, condition2Id, 0b01)
  â””â”€ "Aè¿›å…¥ä½†è¾“" collectionId = getCollectionId(collection1, condition2Id, 0b10)
```

---

## ğŸ” ID è®¡ç®—æµç¨‹

### Condition ID

```
è¾“å…¥:
  oracle = 0x1234...
  questionId = 0xabcd...
  outcomeSlotCount = 3

è®¡ç®—:
  conditionId = keccak256(
    abi.encodePacked(oracle, questionId, outcomeSlotCount)
  )

è¾“å‡º:
  conditionId = 0x5678...
```

### Collection ID

```
è¾“å…¥:
  parentCollectionId = 0x00...00
  conditionId = 0x5678...
  indexSet = 0b011 (ç»“æœ A æˆ– B)

è®¡ç®—æ­¥éª¤:
  1. hash1 = keccak256(conditionId, indexSet)
  2. å°† hash1 æ˜ å°„åˆ°æ¤­åœ†æ›²çº¿ç‚¹ (x1, y1)
  3. å¦‚æœæœ‰çˆ¶é›†åˆ:
     - å°† parentCollectionId æ˜ å°„åˆ°ç‚¹ (x2, y2)
     - ç‚¹åŠ æ³•: (x3, y3) = (x1, y1) + (x2, y2)
  4. ç¼–ç ç‚¹åæ ‡ä¸º bytes32

è¾“å‡º:
  collectionId = 0x9abc...
```

### Position ID

```
è¾“å…¥:
  collateralToken = 0xDAI...
  collectionId = 0x9abc...

è®¡ç®—:
  positionId = uint256(
    keccak256(abi.encodePacked(collateralToken, collectionId))
  )

è¾“å‡º:
  positionId = 12345678901234567890...
```

---

## ğŸ“Š çŠ¶æ€æœºå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœªåˆ›å»º     â”‚
â”‚ (ä¸å­˜åœ¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ prepareCondition()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·²å‡†å¤‡     â”‚
â”‚ (æœªè§£å†³)    â”‚  â† å¯ä»¥ split/merge
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ reportPayouts()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·²è§£å†³     â”‚  â† å¯ä»¥ redeem
â”‚ (å·²æŠ¥å‘Š)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€æ£€æŸ¥

```solidity
// æ£€æŸ¥æ¡ä»¶æ˜¯å¦å·²å‡†å¤‡
if (payoutNumerators[conditionId].length > 0) {
    // å·²å‡†å¤‡
}

// æ£€æŸ¥æ¡ä»¶æ˜¯å¦å·²è§£å†³
if (payoutDenominator[conditionId] > 0) {
    // å·²è§£å†³
}
```

---

## ğŸ¨ ERC1155 é›†æˆ

### ä»£å¸æ˜ å°„

```
ERC1155 Token ID = Position ID

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ConditionalTokens (ERC1155)         â”‚
â”‚                                      â”‚
â”‚  Token ID 1 = Position A             â”‚
â”‚  Token ID 2 = Position B             â”‚
â”‚  Token ID 3 = Position C             â”‚
â”‚  Token ID 4 = Position A|B           â”‚
â”‚  Token ID 5 = Position A|C           â”‚
â”‚  ...                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä½™é¢æŸ¥è¯¢

```
ç”¨æˆ·åœ°å€: 0xUser...
Position ID: 12345...

balanceOf(0xUser..., 12345...) â†’ 100

è¡¨ç¤ºç”¨æˆ·æŒæœ‰ 100 ä¸ªè¯¥ä½ç½®çš„ä»£å¸
```

---

## ğŸ”„ Gas ä¼˜åŒ–ç­–ç•¥

### æ‰¹é‡æ“ä½œ

```
âŒ ä½æ•ˆæ–¹å¼:
  for (let i = 0; i < positions.length; i++) {
    await ct.balanceOf(user, positions[i]);
  }

âœ… é«˜æ•ˆæ–¹å¼:
  const balances = await ct.balanceOfBatch(
    Array(positions.length).fill(user),
    positions
  );
```

### å®Œæ•´åˆ†å‰² vs éƒ¨åˆ†åˆ†å‰²

```
å®Œæ•´åˆ†å‰² (æ›´çœ gas):
  partition = [0b001, 0b010, 0b100]  // è¦†ç›–æ‰€æœ‰ç»“æœ
  â†’ ç›´æ¥é”å®šæŠµæŠ¼å“

éƒ¨åˆ†åˆ†å‰² (æ›´è´µ):
  partition = [0b001, 0b010]  // åªè¦†ç›–éƒ¨åˆ†ç»“æœ
  â†’ éœ€è¦å…ˆæœ‰çˆ¶ä½ç½®ï¼Œç„¶åé”€æ¯çˆ¶ä½ç½®
```

---

## ğŸ§® ä½è¿ç®—æŠ€å·§

### æ£€æŸ¥ä½æ˜¯å¦è®¾ç½®

```javascript
// æ£€æŸ¥ indexSet ä¸­æ˜¯å¦åŒ…å«ç¬¬ n ä¸ªç»“æœ
function hasOutcome(indexSet, n) {
    return (indexSet & (1 << n)) !== 0;
}

// ç¤ºä¾‹
indexSet = 0b0101  // ç»“æœ 0 å’Œ 2
hasOutcome(indexSet, 0)  // true
hasOutcome(indexSet, 1)  // false
hasOutcome(indexSet, 2)  // true
```

### è®¾ç½®ä½

```javascript
// æ·»åŠ ç¬¬ n ä¸ªç»“æœåˆ° indexSet
function addOutcome(indexSet, n) {
    return indexSet | (1 << n);
}

// ç¤ºä¾‹
indexSet = 0b0001  // åªæœ‰ç»“æœ 0
indexSet = addOutcome(indexSet, 2)  // 0b0101 (ç»“æœ 0 å’Œ 2)
```

### æ¸…é™¤ä½

```javascript
// ä» indexSet ç§»é™¤ç¬¬ n ä¸ªç»“æœ
function removeOutcome(indexSet, n) {
    return indexSet & ~(1 << n);
}

// ç¤ºä¾‹
indexSet = 0b0111  // ç»“æœ 0, 1, 2
indexSet = removeOutcome(indexSet, 1)  // 0b0101 (ç»“æœ 0 å’Œ 2)
```

### æ£€æŸ¥äº’ä¸ç›¸äº¤

```javascript
// æ£€æŸ¥ä¸¤ä¸ª indexSet æ˜¯å¦äº’ä¸ç›¸äº¤
function isDisjoint(set1, set2) {
    return (set1 & set2) === 0;
}

// ç¤ºä¾‹
isDisjoint(0b0011, 0b1100)  // true (ä¸é‡å )
isDisjoint(0b0011, 0b0110)  // false (æœ‰é‡å )
```

---

## ğŸ“ˆ å®é™…åº”ç”¨æ¶æ„

### é¢„æµ‹å¸‚åœºå®Œæ•´ç³»ç»Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å‰ç«¯ DApp                          â”‚
â”‚  - React / Vue                                      â”‚
â”‚  - Web3.js / Ethers.js                             â”‚
â”‚  - MetaMask é›†æˆ                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ™ºèƒ½åˆçº¦å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Conditional  â”‚  â”‚   AMM/DEX    â”‚                â”‚
â”‚  â”‚   Tokens     â”‚â—„â”€â”¤  (Uniswap)   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                                           â”‚
â”‚         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  ERC20 ä»£å¸  â”‚  â”‚   é¢„è¨€æœº     â”‚                â”‚
â”‚  â”‚  (DAI/USDC)  â”‚  â”‚ (Reality.eth)â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åŒºå—é“¾ç½‘ç»œ                             â”‚
â”‚  Ethereum / xDai / Polygon                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
1. ç”¨æˆ·åˆ›å»ºå¸‚åœº
   â””â”€> prepareCondition()

2. ç”¨æˆ·æä¾›æµåŠ¨æ€§
   â””â”€> splitPosition() + æ·»åŠ åˆ° AMM

3. äº¤æ˜“è€…ä¹°å–
   â””â”€> AMM swap æˆ– P2P è½¬è´¦

4. äº‹ä»¶å‘ç”Ÿ
   â””â”€> é¢„è¨€æœºæŠ¥å‘Š â†’ reportPayouts()

5. ç”¨æˆ·èµå›
   â””â”€> redeemPositions()
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒæ•°æ®ç»“æ„

```
Condition {
    conditionId: bytes32
    payoutNumerators: uint[]
    payoutDenominator: uint
}

Position {
    positionId: uint256 (ERC1155 Token ID)
    collateralToken: address
    collectionId: bytes32
}

Collection {
    collectionId: bytes32
    parentCollectionId: bytes32
    conditionId: bytes32
    indexSet: uint
}
```
ğŸ¯ åœºæ™¯è®¾å®šï¼ˆå›ºå®šä¸å˜ï¼‰
é—®é¢˜ï¼ˆConditionï¼‰

æ˜å¤©ä¸‹é›¨å—ï¼Ÿ

åªæœ‰ä¸¤ä¸ªç»“æœï¼š

outcome 0ï¼šYES

outcome 1ï¼šNO

æŠµæŠ¼å“ï¼šUSDC

ä¸€ã€Conditionï¼šâ€œè¿™é“é¢˜ + æœ€ç»ˆç­”æ¡ˆæ€ä¹ˆåˆ†â€
Condition {
    conditionId: bytes32
    payoutNumerators: uint[]
    payoutDenominator: uint
}

1ï¸âƒ£ conditionIdï¼ˆå”¯ä¸€æ ‡è¯†è¿™é“é¢˜ï¼‰

å‡è®¾ï¼š

oracle = 0xORACLE
questionId = 0xQ123
outcomeSlotCount = 2


é“¾ä¸Šç®—ï¼š

conditionId = keccak256(oracle, questionId, 2)
            = 0xC0ND


ğŸ‘‰ conditionId = â€œæ˜å¤©ä¸‹é›¨å—ï¼ˆç”± oracle åˆ¤ï¼‰â€ è¿™é“é¢˜çš„èº«ä»½è¯

2ï¸âƒ£ oracle æŠ¥ç»“æœï¼ˆä¸‹é›¨äº†ï¼‰
reportPayouts(questionId, [1, 0])


é“¾ä¸ŠçŠ¶æ€å˜æˆï¼š

Condition {
    conditionId: 0xC0ND
    payoutNumerators: [1, 0]   // YES èµ¢ï¼ŒNO è¾“
    payoutDenominator: 1
}

äººè¯ç¿»è¯‘ï¼š

YESï¼š1 / 1 = 100%

NOï¼š 0 / 1 = 0%

äºŒã€Collectionï¼šâ€œåœ¨æŸä¸ªæ¡ä»¶ä¸‹ï¼Œå“ªäº›ç»“æœç®—èµ¢â€
Collection {
    collectionId: bytes32
    parentCollectionId: bytes32
    conditionId: bytes32
    indexSet: uint
}


Collection = â€œç»“æœçš„é›†åˆâ€

outcome çš„ bit è¡¨ç¤ºï¼ˆéå¸¸é‡è¦ï¼‰
ç»“æœ	index	bit	å€¼
YES	0	01	1
NO	1	10	2
1ï¸âƒ£ æœ€é¡¶å±‚ Collectionï¼ˆå…¨é›†ï¼‰
indexSet = 1 | 2 = 3   // 0b11 = YES æˆ– NO

Collection {
    collectionId: 0xCOL_ALL
    parentCollectionId: 0x0
    conditionId: 0xC0ND
    indexSet: 3
}


ğŸ‘‰ â€œä¸ç®¡ä¸‹é›¨è¿˜æ˜¯ä¸ä¸‹é›¨ï¼Œéƒ½ç®—â€
ï¼ˆè¿™æ˜¯â€œæ•´å¼ é’±â€çš„æŠ½è±¡ï¼‰

2ï¸âƒ£ YES Collection
indexSet = 1   // 0b01

Collection {
    collectionId: 0xCOL_YES
    parentCollectionId: 0x0
    conditionId: 0xC0ND
    indexSet: 1
}


ğŸ‘‰ â€œåªæœ‰ YES æ‰ç®—èµ¢â€

3ï¸âƒ£ NO Collection
indexSet = 2   // 0b10

Collection {
    collectionId: 0xCOL_NO
    parentCollectionId: 0x0
    conditionId: 0xC0ND
    indexSet: 2
}


ğŸ‘‰ â€œåªæœ‰ NO æ‰ç®—èµ¢â€

ä¸‰ã€Positionï¼šâ€œç”¨æŸç§é’±ï¼Œä¹°äº†å“ªç§ Collectionâ€
Position {
    positionId: uint256
    collateralToken: address
    collectionId: bytes32
}


Position = â€œå…·ä½“çš„ä¸€å¼ ç¥¨ï¼ˆERC1155 tokenï¼‰â€

1ï¸âƒ£ YES Positionï¼ˆæœ€é‡è¦ï¼‰
Position {
    positionId: hash(USDC, 0xCOL_YES)
    collateralToken: USDC
    collectionId: 0xCOL_YES
}


ğŸ‘‰ è¿™å°±æ˜¯ä½ é’±åŒ…é‡Œçœ‹åˆ°çš„ YES ç¥¨

2ï¸âƒ£ NO Position
Position {
    positionId: hash(USDC, 0xCOL_NO)
    collateralToken: USDC
    collectionId: 0xCOL_NO
}


ğŸ‘‰ è¿™å°±æ˜¯ NO ç¥¨

3ï¸âƒ£ â€œæ•´ç¥¨â€ Positionï¼ˆçˆ¶ç¥¨ï¼‰
Position {
    positionId: hash(USDC, 0xCOL_ALL)
    collateralToken: USDC
    collectionId: 0xCOL_ALL
}


ğŸ‘‰ ä»£è¡¨â€œ1 USDCï¼Œä¸ç®¡ç»“æœâ€

å››ã€ä¸‰è€…æ˜¯æ€ä¹ˆä¸²èµ·æ¥çš„ï¼ˆè¶…çº§å…³é”®ï¼‰

æˆ‘ä»¬ç”¨ä¸€å¥è¯ä¸²èµ·æ¥ï¼š

Condition å†³å®šâ€œæ€ä¹ˆç®—èµ¢â€
Collection å†³å®šâ€œå“ªäº›ç»“æœç®—èµ¢â€
Position å†³å®šâ€œä½ ç”¨ä»€ä¹ˆé’±æŠ¼äº†å“ªç§èµ¢æ³•â€

ä¸€å¼ å®Œæ•´å…³ç³»è¡¨
Condition (0xC0ND)
â”‚
â”œâ”€ Collection (indexSet=1)  â†’ YES
â”‚   â””â”€ Position (USDC, YES)
â”‚
â”œâ”€ Collection (indexSet=2)  â†’ NO
â”‚   â””â”€ Position (USDC, NO)
â”‚
â””â”€ Collection (indexSet=3)  â†’ YES or NO
    â””â”€ Position (USDC, ALL)

äº”ã€ä¸ºä»€ä¹ˆè¦åˆ†æˆè¿™ä¸‰å±‚ï¼Ÿï¼ˆæœ¬è´¨ï¼‰
å¦‚æœæ²¡æœ‰ Collection

ä½ åªèƒ½æŠ¼ YES æˆ– NO

æ²¡æ³• (A|C)

æ²¡æ³• AND / OR

å¦‚æœæ²¡æœ‰ Position

ä½ æ²¡æ³•ç”¨ä¸åŒæŠµæŠ¼å“

æ²¡æ³• ERC1155 ç»Ÿä¸€ç®¡ç†

å¦‚æœæ²¡æœ‰ Condition

æ²¡æ³•ç»Ÿä¸€ç»“ç®—

oracle æ²¡åœ°æ–¹æŠ¥ç»“æœ

å…­ã€ç”¨ä¸€å¥â€œä½ ç°åœ¨ä¸€å®šèƒ½å¤è¿°â€çš„è¯æ€»ç»“

Condition æ˜¯â€œé¢˜ç›® + æ ‡å‡†ç­”æ¡ˆâ€
Collection æ˜¯â€œå“ªäº›ç­”æ¡ˆç®—èµ¢â€
Position æ˜¯â€œæˆ‘ç”¨ä»€ä¹ˆé’±ï¼Œä¹°äº†å“ªç§èµ¢æ³•â€
### å…³é”®å…¬å¼

```
conditionId = keccak256(oracle, questionId, outcomeSlotCount)

collectionId = ellipticCurveAdd(
    hash(conditionId, indexSet),
    parentCollectionId
)

positionId = keccak256(collateralToken, collectionId)

payout = balance * payoutNumerator / payoutDenominator
```

---

**å¸Œæœ›è¿™äº›å›¾è§£èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ Conditional Tokensï¼** ğŸ‰


