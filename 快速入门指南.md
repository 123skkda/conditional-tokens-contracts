# Conditional Tokens å¿«é€Ÿå…¥é—¨æŒ‡å— âš¡

> 5åˆ†é’Ÿå¿«é€Ÿç†è§£å’Œä½¿ç”¨ Conditional Tokens

---

## ğŸ¯ ä¸€å¥è¯æ€»ç»“

**Conditional Tokens è®©ä½ å¯ä»¥åˆ›å»º"å¦‚æœXå‘ç”Ÿï¼Œæˆ‘å°±èƒ½è·å¾—Y"çš„ä»£å¸åŒ–æƒç›Šã€‚**

---

## ğŸ§  æ ¸å¿ƒæ¦‚å¿µé€Ÿè®°

### 1ï¸âƒ£ æ¡ä»¶ (Condition)
ä¸€ä¸ªéœ€è¦å›ç­”çš„é—®é¢˜ï¼Œæ¯”å¦‚"æ˜å¤©ä¼šä¸‹é›¨å—ï¼Ÿ"

```
æ¡ä»¶ = é¢„è¨€æœºåœ°å€ + é—®é¢˜ID + ç»“æœæ•°é‡
```

### 2ï¸âƒ£ ä½ç½® (Position)  
ä½ åœ¨æŸä¸ªç»“æœä¸Šçš„èµŒæ³¨ï¼Œä»¥ ERC1155 ä»£å¸å½¢å¼å­˜åœ¨

```
ä½ç½® = æŠµæŠ¼ä»£å¸ + ç»“æœç»„åˆ
```

### 3ï¸âƒ£ åˆ†å‰² (Split)
æŠŠé’±ï¼ˆæŠµæŠ¼å“ï¼‰å˜æˆå¤šä¸ª"å¯èƒ½æ€§ä»£å¸"

```
100 DAI â†’ 100ä¸ª"ä¼šä¸‹é›¨"ä»£å¸ + 100ä¸ª"ä¸ä¼šä¸‹é›¨"ä»£å¸
```

### 4ï¸âƒ£ åˆå¹¶ (Merge)
æŠŠ"å¯èƒ½æ€§ä»£å¸"å˜å›é’±

```
100ä¸ª"ä¼šä¸‹é›¨"ä»£å¸ + 100ä¸ª"ä¸ä¼šä¸‹é›¨"ä»£å¸ â†’ 100 DAI
```

### 5ï¸âƒ£ èµå› (Redeem)
äº‹ä»¶å‘ç”Ÿåï¼Œç”¨æ­£ç¡®çš„ä»£å¸æ¢å›é’±

```
å¦‚æœä¸‹é›¨äº†ï¼š100ä¸ª"ä¼šä¸‹é›¨"ä»£å¸ â†’ 100 DAI
å¦‚æœæ²¡ä¸‹é›¨ï¼š100ä¸ª"ä¸ä¼šä¸‹é›¨"ä»£å¸ â†’ 100 DAI
```

---

## ğŸš€ 5æ­¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªé¢„æµ‹å¸‚åœº

### æ­¥éª¤ 1: å‡†å¤‡æ¡ä»¶

```javascript
// "æ˜å¤©ä¼šä¸‹é›¨å—ï¼Ÿ" [ä¼š, ä¸ä¼š]
await conditionalTokens.prepareCondition(
    oracleAddress,           // è°æ¥æŠ¥å‘Šç»“æœ
    questionId,              // é—®é¢˜çš„å”¯ä¸€ID
    2                        // 2ä¸ªå¯èƒ½ç»“æœ
);
```

### æ­¥éª¤ 2: æˆæƒæŠµæŠ¼ä»£å¸

```javascript
// å…è®¸åˆçº¦ä½¿ç”¨ä½ çš„ DAI
await dai.approve(
    conditionalTokens.address,
    ethers.utils.parseEther("100")
);
```

### æ­¥éª¤ 3: åˆ†å‰²æŠµæŠ¼å“

```javascript
// æŠŠ 100 DAI åˆ†æˆä¸¤ä¸ªä½ç½®
await conditionalTokens.splitPosition(
    dai.address,             // ä½¿ç”¨ DAI ä½œä¸ºæŠµæŠ¼
    "0x00...00",            // æ²¡æœ‰çˆ¶æ¡ä»¶
    conditionId,            // æ¡ä»¶ID
    [0b01, 0b10],          // [ä¼šä¸‹é›¨, ä¸ä¼šä¸‹é›¨]
    ethers.utils.parseEther("100")
);
```

**ç»“æœ**: ä½ ç°åœ¨æœ‰ 100 ä¸ª"ä¼šä¸‹é›¨"ä»£å¸ + 100 ä¸ª"ä¸ä¼šä¸‹é›¨"ä»£å¸

### æ­¥éª¤ 4: é¢„è¨€æœºæŠ¥å‘Šç»“æœ

```javascript
// ç¬¬äºŒå¤©ï¼Œé¢„è¨€æœºæŠ¥å‘Šï¼šä¸‹é›¨äº†ï¼
await conditionalTokens.reportPayouts(
    questionId,
    [1, 0],                 // ç¬¬ä¸€ä¸ªç»“æœæ­£ç¡®
    { from: oracleAddress }
);
```

### æ­¥éª¤ 5: èµå›ä»£å¸

```javascript
// æŒæœ‰"ä¼šä¸‹é›¨"ä»£å¸çš„äººèµå›
await conditionalTokens.redeemPositions(
    dai.address,
    "0x00...00",
    conditionId,
    [0b01]                  // èµå›"ä¼šä¸‹é›¨"ä½ç½®
);
```

**ç»“æœ**: æ”¶åˆ° 100 DAIï¼

---

## ğŸ’¡ å®ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: äºŒå…ƒé¢„æµ‹ï¼ˆæ˜¯/å¦ï¼‰

```javascript
// "ç‰¹æœ—æ™®ä¼šèµ¢å¾—2024å¤§é€‰å—ï¼Ÿ"
outcomeSlotCount = 2
partition = [0b01, 0b10]  // [ä¼š, ä¸ä¼š]
```

### ç¤ºä¾‹ 2: å¤šé€‰é¢„æµ‹

```javascript
// "è°ä¼šèµ¢å¾—ä¸–ç•Œæ¯ï¼Ÿ"
outcomeSlotCount = 4
partition = [0b0001, 0b0010, 0b0100, 0b1000]  
// [å·´è¥¿, é˜¿æ ¹å»·, å¾·å›½, æ³•å›½]
```

### ç¤ºä¾‹ 3: ç»„åˆé¢„æµ‹

```javascript
// "å·´è¥¿æˆ–é˜¿æ ¹å»·ä¼šèµ¢"
indexSet = 0b0011  // ç¬¬0ä½å’Œç¬¬1ä½éƒ½æ˜¯1
```

### ç¤ºä¾‹ 4: éƒ¨åˆ†åˆ†å‰²

```javascript
// åªåˆ†å‰²"å·´è¥¿æˆ–é˜¿æ ¹å»·"è¿™ä¸ªç»„åˆ
partition = [0b0001, 0b0010]  // [å·´è¥¿, é˜¿æ ¹å»·]
// æ³¨æ„ï¼šè¿™ä¸æ˜¯å®Œæ•´åˆ†å‰²ï¼Œéœ€è¦å·²æœ‰"å·´è¥¿æˆ–é˜¿æ ¹å»·"çš„çˆ¶ä½ç½®
```

---

## ğŸ”§ å¸¸ç”¨å·¥å…·å‡½æ•°

### è®¡ç®—æ¡ä»¶ID

```javascript
const conditionId = web3.utils.soliditySha3(
    { t: 'address', v: oracleAddress },
    { t: 'bytes32', v: questionId },
    { t: 'uint', v: outcomeSlotCount }
);
```

### è®¡ç®—ä½ç½®ID

```javascript
const { getPositionId, getCollectionId } = require('./utils/id-helpers');

const collectionId = getCollectionId(
    parentCollectionId,
    conditionId,
    indexSet
);

const positionId = getPositionId(
    collateralToken,
    collectionId
);
```

### æŸ¥è¯¢ä½™é¢

```javascript
const balance = await conditionalTokens.balanceOf(
    userAddress,
    positionId
);
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### âœ… åšè¿™äº›

- âœ… åœ¨åˆ†å‰²å‰æˆæƒæŠµæŠ¼ä»£å¸
- âœ… ç¡®ä¿åˆ†åŒºäº’ä¸ç›¸äº¤ï¼ˆä¸é‡å ï¼‰
- âœ… ä½¿ç”¨å¯ä¿¡çš„é¢„è¨€æœº
- âœ… åœ¨æµ‹è¯•ç½‘å…ˆæµ‹è¯•

### âŒ ä¸è¦åšè¿™äº›

- âŒ ä¸è¦é‡å¤å‡†å¤‡åŒä¸€ä¸ªæ¡ä»¶
- âŒ ä¸è¦è®©éé¢„è¨€æœºæŠ¥å‘Šç»“æœ
- âŒ ä¸è¦åˆ›å»ºè¶…è¿‡256ä¸ªç»“æœ
- âŒ ä¸è¦åœ¨ä¸»ç½‘ç›´æ¥æµ‹è¯•

---

## ğŸ“ ä½æ©ç é€ŸæŸ¥è¡¨

```
ç»“æœæ•°é‡: 4 [A, B, C, D]

å•ä¸ªç»“æœ:
A = 0b0001 = 1
B = 0b0010 = 2
C = 0b0100 = 4
D = 0b1000 = 8

ç»„åˆç»“æœ:
Aæˆ–B = 0b0011 = 3
Aæˆ–C = 0b0101 = 5
Bæˆ–C = 0b0110 = 6
Aæˆ–Bæˆ–C = 0b0111 = 7
æ‰€æœ‰ç»“æœ = 0b1111 = 15
```

**è®¡ç®—å…¬å¼**: ç¬¬ n ä¸ªç»“æœçš„ä½æ©ç  = 2^n

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
1. å‡†å¤‡æ¡ä»¶
   â†“
2. ç”¨æˆ·æˆæƒæŠµæŠ¼ä»£å¸
   â†“
3. åˆ†å‰²æŠµæŠ¼å“ â†’ è·å¾—ä½ç½®ä»£å¸
   â†“
4. äº¤æ˜“ä½ç½®ä»£å¸ï¼ˆå¯é€‰ï¼‰
   â†“
5. é¢„è¨€æœºæŠ¥å‘Šç»“æœ
   â†“
6. èµå›ä½ç½®ä»£å¸ â†’ è·å¾—æŠµæŠ¼å“
```

---

## ğŸ§ª æœ¬åœ°æµ‹è¯•

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/gnosis/conditional-tokens-contracts.git
cd conditional-tokens-contracts

# 2. å®‰è£…ä¾èµ–
npm install

# 3. ç¼–è¯‘
npm run compile

# 4. è¿è¡Œæµ‹è¯•
npm test

# 5. å¯åŠ¨æœ¬åœ°èŠ‚ç‚¹
ganache-cli

# 6. éƒ¨ç½²ï¼ˆæ–°ç»ˆç«¯ï¼‰
truffle migrate --network development
```

---

## ğŸ“š ä¸‹ä¸€æ­¥å­¦ä¹ 

1. **é˜…è¯»å®Œæ•´æ–‡æ¡£**: `æ¡ä»¶ä»£å¸åˆçº¦ä¸­æ–‡æ–‡æ¡£.md`
2. **æŸ¥çœ‹æµ‹è¯•ç”¨ä¾‹**: `test/test-conditional-tokens.js`
3. **ç ”ç©¶æ ¸å¿ƒåˆçº¦**: `contracts/ConditionalTokens.sol`
4. **æ¢ç´¢è¾…åŠ©åº“**: `contracts/CTHelpers.sol`

---

## ğŸ†˜ é‡åˆ°é—®é¢˜ï¼Ÿ

### å¸¸è§é”™è¯¯

**"condition already prepared"**  
â†’ è¿™ä¸ªæ¡ä»¶å·²ç»åˆ›å»ºè¿‡äº†ï¼Œä½¿ç”¨ä¸åŒçš„ questionId

**"partition not disjoint"**  
â†’ åˆ†åŒºæœ‰é‡å ï¼Œæ£€æŸ¥ä½æ©ç 

**"could not receive collateral tokens"**  
â†’ æ²¡æœ‰æˆæƒæˆ–ä½™é¢ä¸è¶³

**"result for condition not received yet"**  
â†’ é¢„è¨€æœºè¿˜æ²¡æŠ¥å‘Šç»“æœï¼Œä¸èƒ½èµå›

---

## ğŸŒŸ å®æˆ˜æŠ€å·§

### æŠ€å·§ 1: æµ‹è¯•åˆ†åŒºæ˜¯å¦æœ‰æ•ˆ

```javascript
// æ£€æŸ¥åˆ†åŒºæ˜¯å¦è¦†ç›–æ‰€æœ‰ç»“æœ
const fullSet = (1 << outcomeSlotCount) - 1;
const sum = partition.reduce((a, b) => a | b, 0);
console.log(sum === fullSet); // true = å®Œæ•´åˆ†åŒº
```

### æŠ€å·§ 2: æ‰¹é‡æŸ¥è¯¢ä½™é¢

```javascript
const positions = [positionId1, positionId2, positionId3];
const users = [user, user, user];
const balances = await conditionalTokens.balanceOfBatch(users, positions);
```

### æŠ€å·§ 3: ç›‘å¬äº‹ä»¶

```javascript
conditionalTokens.on('ConditionPreparation', (conditionId, oracle, questionId, outcomeSlotCount) => {
    console.log('æ–°æ¡ä»¶åˆ›å»º:', conditionId);
});

conditionalTokens.on('PositionSplit', (stakeholder, collateralToken, parentCollectionId, conditionId, partition, amount) => {
    console.log('ä½ç½®åˆ†å‰²:', stakeholder, amount);
});
```

---

**ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰**

æœ‰é—®é¢˜ï¼ŸæŸ¥çœ‹å®Œæ•´æ–‡æ¡£æˆ–æäº¤ Issueï¼


