# Conditional Tokens æ¡ä»¶ä»£å¸åˆçº¦ - ä¸­æ–‡å®Œæ•´æŒ‡å—

## ğŸ“š ç›®å½•
1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
4. [æ ¸å¿ƒåˆçº¦è¯¦è§£](#æ ¸å¿ƒåˆçº¦è¯¦è§£)
5. [ä½¿ç”¨æµç¨‹](#ä½¿ç”¨æµç¨‹)
6. [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
7. [å¼€å‘ç¯å¢ƒæ­å»º](#å¼€å‘ç¯å¢ƒæ­å»º)

---

## é¡¹ç›®æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ Conditional Tokensï¼Ÿ

**Conditional Tokensï¼ˆæ¡ä»¶ä»£å¸ï¼‰** æ˜¯ Gnosis å¼€å‘çš„ä¸€å¥—æ™ºèƒ½åˆçº¦ç³»ç»Ÿï¼Œç”¨äºåœ¨ä»¥å¤ªåŠä¸Šåˆ›å»ºå’Œç®¡ç†**æ¡ä»¶æ€§ä»£å¸**ã€‚è¿™äº›ä»£å¸çš„ä»·å€¼å–å†³äºæœªæ¥äº‹ä»¶çš„ç»“æœã€‚

### ä¸»è¦ç”¨é€”

- **é¢„æµ‹å¸‚åœº**ï¼šåˆ›å»ºåŸºäºçœŸå®ä¸–ç•Œäº‹ä»¶çš„é¢„æµ‹å¸‚åœº
- **ç»„åˆé¢„æµ‹**ï¼šæ”¯æŒå¤æ‚çš„æ¡ä»¶ç»„åˆï¼ˆä¾‹å¦‚ï¼š"å¦‚æœ A å‘ç”Ÿï¼Œé‚£ä¹ˆ B çš„æ¦‚ç‡æ˜¯å¤šå°‘ï¼Ÿ"ï¼‰
- **ä¿¡æ¯å‘ç°**ï¼šé€šè¿‡å¸‚åœºæœºåˆ¶å‘ç°æ¡ä»¶æ¦‚ç‡ä¿¡æ¯
- **é£é™©å¯¹å†²**ï¼šä¸ºä¸ç¡®å®šäº‹ä»¶åˆ›å»ºå¯¹å†²å·¥å…·

### æ ¸å¿ƒç‰¹æ€§

âœ… åŸºäº **ERC1155** å¤šä»£å¸æ ‡å‡†  
âœ… æ”¯æŒæœ€å¤š **256** ä¸ªç»“æœé€‰é¡¹  
âœ… æ”¯æŒ**åµŒå¥—æ¡ä»¶**ï¼ˆæ¡ä»¶çš„æ¡ä»¶ï¼‰  
âœ… **æ— éœ€è®¸å¯**ï¼šä»»ä½•äººéƒ½å¯ä»¥åˆ›å»ºæ¡ä»¶  
âœ… **å»ä¸­å¿ƒåŒ–**ï¼šç”±é¢„è¨€æœºæŠ¥å‘Šç»“æœ  

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. æ¡ä»¶ (Condition)

**æ¡ä»¶**æ˜¯ä¸€ä¸ªéœ€è¦è¢«å›ç­”çš„é—®é¢˜ï¼Œç”±é¢„è¨€æœºæœ€ç»ˆç»™å‡ºç­”æ¡ˆã€‚

**ç»„æˆéƒ¨åˆ†ï¼š**
- **Oracleï¼ˆé¢„è¨€æœºï¼‰**ï¼šè´Ÿè´£æŠ¥å‘Šç»“æœçš„è´¦æˆ·åœ°å€
- **Question IDï¼ˆé—®é¢˜ IDï¼‰**ï¼šé—®é¢˜çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆbytes32ï¼‰
- **Outcome Slot Countï¼ˆç»“æœæ§½æ•°é‡ï¼‰**ï¼šå¯èƒ½çš„ç»“æœæ•°é‡ï¼ˆ2-256ï¼‰

**æ¡ä»¶ ID è®¡ç®—æ–¹å¼ï¼š**
```solidity
conditionId = keccak256(abi.encodePacked(oracle, questionId, outcomeSlotCount))
```

**ç¤ºä¾‹ï¼š**
- é—®é¢˜ï¼š"2024å¹´ä¸–ç•Œæ¯å† å†›æ˜¯è°ï¼Ÿ"
- ç»“æœé€‰é¡¹ï¼š[å·´è¥¿, é˜¿æ ¹å»·, å¾·å›½, æ³•å›½] â†’ 4ä¸ªç»“æœæ§½
- é¢„è¨€æœºï¼šFIFAå®˜æ–¹åœ°å€

### 2. ä½ç½® (Position)

**ä½ç½®**ä»£è¡¨æŒæœ‰è€…åœ¨ç‰¹å®šç»“æœç»„åˆä¸Šçš„æƒç›Šï¼Œä»¥ ERC1155 ä»£å¸å½¢å¼å­˜åœ¨ã€‚

**ç»„æˆéƒ¨åˆ†ï¼š**
- **Collateral Tokenï¼ˆæŠµæŠ¼ä»£å¸ï¼‰**ï¼šæ”¯æŒè¯¥ä½ç½®çš„ ERC20 ä»£å¸ï¼ˆå¦‚ DAIã€USDCï¼‰
- **Collection IDï¼ˆé›†åˆ IDï¼‰**ï¼šç»“æœé›†åˆçš„æ ‡è¯†ç¬¦

**ä½ç½® ID è®¡ç®—æ–¹å¼ï¼š**
```solidity
positionId = keccak256(abi.encodePacked(collateralToken, collectionId))
```

### 3. ç»“æœé›†åˆ (Outcome Collection)

ä½¿ç”¨**ä½æ©ç ï¼ˆbit maskï¼‰**è¡¨ç¤ºç»“æœçš„ç»„åˆã€‚

**ç¤ºä¾‹ï¼ˆ4ä¸ªç»“æœï¼‰ï¼š**
- `0b0001` (1) = åªæœ‰ç»“æœ A
- `0b0010` (2) = åªæœ‰ç»“æœ B  
- `0b0011` (3) = ç»“æœ A æˆ– B
- `0b1111` (15) = æ‰€æœ‰ç»“æœï¼ˆå®Œæ•´é›†åˆï¼‰

### 4. åˆ†å‰² (Split) å’Œ åˆå¹¶ (Merge)

**åˆ†å‰²**ï¼šå°†æŠµæŠ¼å“æˆ–çˆ¶ä½ç½®åˆ†æˆå¤šä¸ªå­ä½ç½®  
**åˆå¹¶**ï¼šå°†å¤šä¸ªå­ä½ç½®åˆå¹¶å›æŠµæŠ¼å“æˆ–çˆ¶ä½ç½®

**å…³é”®è§„åˆ™ï¼š**
- åˆ†å‰²çš„ç»“æœé›†åˆå¿…é¡»**äº’ä¸ç›¸äº¤**ï¼ˆdisjointï¼‰
- åˆ†å‰²å®Œæ•´é›†åˆæ—¶ï¼Œéœ€è¦é”å®šæŠµæŠ¼ä»£å¸
- åˆå¹¶æ—¶é”€æ¯å­ä½ç½®ï¼Œé‡Šæ”¾æŠµæŠ¼å“

### 5. èµå› (Redemption)

æ¡ä»¶è§£å†³åï¼Œæ ¹æ®é¢„è¨€æœºæŠ¥å‘Šçš„**æ”¯ä»˜å‘é‡ï¼ˆpayout vectorï¼‰**èµå›æŠµæŠ¼å“ã€‚

**æ”¯ä»˜å‘é‡ç¤ºä¾‹ï¼š**
- é—®é¢˜ï¼š"è°èµ¢äº†æ¯”èµ›ï¼Ÿ" [é˜Ÿä¼A, é˜Ÿä¼B, å¹³å±€]
- ç»“æœï¼šé˜Ÿä¼A èµ¢äº†
- æ”¯ä»˜å‘é‡ï¼š`[1, 0, 0]` â†’ åˆ†æ¯ä¸º 1
- æŒæœ‰"é˜Ÿä¼A"ä½ç½®çš„äººå¯ä»¥ 1:1 èµå›æŠµæŠ¼å“

---

## æŠ€æœ¯æ¶æ„

### åˆçº¦ç»“æ„

```
conditional-tokens-contracts/
â”œâ”€â”€ contracts/
â”‚   â”œâ”€â”€ ConditionalTokens.sol      # æ ¸å¿ƒåˆçº¦
â”‚   â”œâ”€â”€ CTHelpers.sol               # è¾…åŠ©å‡½æ•°åº“
â”‚   â””â”€â”€ ERC1155/                    # ERC1155 å®ç°
â”‚       â”œâ”€â”€ ERC1155.sol
â”‚       â”œâ”€â”€ IERC1155.sol
â”‚       â””â”€â”€ IERC1155TokenReceiver.sol
â”œâ”€â”€ test/                           # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ migrations/                     # éƒ¨ç½²è„šæœ¬
â””â”€â”€ utils/                          # å·¥å…·å‡½æ•°
```

### æŠ€æœ¯æ ˆ

- **Solidity**: 0.5.10
- **æ¡†æ¶**: Truffle
- **ä»£å¸æ ‡å‡†**: ERC1155
- **ä¾èµ–**: OpenZeppelin Solidity 2.3.0
- **æµ‹è¯•**: Mocha + Chai

---

## æ ¸å¿ƒåˆçº¦è¯¦è§£

### ConditionalTokens.sol

è¿™æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒåˆçº¦ï¼Œç»§æ‰¿è‡ª ERC1155ã€‚

#### ä¸»è¦çŠ¶æ€å˜é‡

```solidity
// æ¡ä»¶ID â†’ æ”¯ä»˜åˆ†å­æ•°ç»„
mapping(bytes32 => uint[]) public payoutNumerators;

// æ¡ä»¶ID â†’ æ”¯ä»˜åˆ†æ¯
mapping(bytes32 => uint) public payoutDenominator;
```

**çŠ¶æ€åˆ¤æ–­ï¼š**
- `payoutNumerators[conditionId].length == 0` â†’ æ¡ä»¶æœªå‡†å¤‡
- `payoutNumerators[conditionId].length > 0` â†’ æ¡ä»¶å·²å‡†å¤‡
- `payoutDenominator[conditionId] > 0` â†’ æ¡ä»¶å·²è§£å†³

#### æ ¸å¿ƒå‡½æ•°

##### 1. prepareCondition - å‡†å¤‡æ¡ä»¶

```solidity
function prepareCondition(
    address oracle,
    bytes32 questionId,
    uint outcomeSlotCount
) external
```

**åŠŸèƒ½**ï¼šåˆå§‹åŒ–ä¸€ä¸ªæ–°æ¡ä»¶  
**é™åˆ¶**ï¼š
- ç»“æœæ•°é‡å¿…é¡»åœ¨ 2-256 ä¹‹é—´
- åŒä¸€æ¡ä»¶ä¸èƒ½é‡å¤å‡†å¤‡

**äº‹ä»¶**ï¼š
```solidity
event ConditionPreparation(
    bytes32 indexed conditionId,
    address indexed oracle,
    bytes32 indexed questionId,
    uint outcomeSlotCount
)
```

##### 2. reportPayouts - æŠ¥å‘Šç»“æœ

```solidity
function reportPayouts(
    bytes32 questionId,
    uint[] calldata payouts
) external
```

**åŠŸèƒ½**ï¼šé¢„è¨€æœºæŠ¥å‘Šæ¡ä»¶çš„ç»“æœ
**é™åˆ¶**ï¼š
- åªæœ‰é¢„è¨€æœºï¼ˆmsg.senderï¼‰å¯ä»¥è°ƒç”¨
- æ¡ä»¶å¿…é¡»å·²å‡†å¤‡
- ä¸èƒ½é‡å¤æŠ¥å‘Š
- æ”¯ä»˜å‘é‡æ€»å’Œå¿…é¡» > 0

**äº‹ä»¶**ï¼š
```solidity
event ConditionResolution(
    bytes32 indexed conditionId,
    address indexed oracle,
    bytes32 indexed questionId,
    uint outcomeSlotCount,
    uint[] payoutNumerators
)
```

##### 3. splitPosition - åˆ†å‰²ä½ç½®

```solidity
function splitPosition(
    IERC20 collateralToken,
    bytes32 parentCollectionId,
    bytes32 conditionId,
    uint[] calldata partition,
    uint amount
) external
```

**åŠŸèƒ½**ï¼šå°†æŠµæŠ¼å“æˆ–çˆ¶ä½ç½®åˆ†å‰²æˆå¤šä¸ªå­ä½ç½®

**å‚æ•°è¯´æ˜**ï¼š
- `collateralToken`: æŠµæŠ¼ä»£å¸åœ°å€
- `parentCollectionId`: çˆ¶é›†åˆIDï¼ˆå¦‚æœä»æŠµæŠ¼å“åˆ†å‰²åˆ™ä¸º 0x0ï¼‰
- `conditionId`: è¦åˆ†å‰²çš„æ¡ä»¶ID
- `partition`: åˆ†åŒºæ•°ç»„ï¼ˆä½æ©ç æ•°ç»„ï¼‰
- `amount`: åˆ†å‰²æ•°é‡

**å·¥ä½œæµç¨‹**ï¼š
1. éªŒè¯åˆ†åŒºæœ‰æ•ˆæ€§ï¼ˆäº’ä¸ç›¸äº¤ã€éç©ºï¼‰
2. å¦‚æœåˆ†å‰²å®Œæ•´é›†åˆï¼š
   - ä»ç”¨æˆ·è½¬å…¥æŠµæŠ¼ä»£å¸ï¼ˆå¦‚æœ parentCollectionId == 0ï¼‰
   - æˆ–é”€æ¯çˆ¶ä½ç½®ä»£å¸
3. é“¸é€ æ–°çš„å­ä½ç½®ä»£å¸ç»™ç”¨æˆ·

**ç¤ºä¾‹**ï¼š
```javascript
// å°† 100 DAI åˆ†å‰²æˆ [A, B, C] ä¸‰ä¸ªä½ç½®
partition = [0b001, 0b010, 0b100]  // [1, 2, 4]
amount = 100
```

##### 4. mergePositions - åˆå¹¶ä½ç½®

```solidity
function mergePositions(
    IERC20 collateralToken,
    bytes32 parentCollectionId,
    bytes32 conditionId,
    uint[] calldata partition,
    uint amount
) external
```

**åŠŸèƒ½**ï¼šå°†å¤šä¸ªå­ä½ç½®åˆå¹¶å›æŠµæŠ¼å“æˆ–çˆ¶ä½ç½®

**å·¥ä½œæµç¨‹**ï¼š
1. é”€æ¯æ‰€æœ‰å­ä½ç½®ä»£å¸
2. å¦‚æœåˆå¹¶å®Œæ•´é›†åˆï¼š
   - è½¬å‡ºæŠµæŠ¼ä»£å¸ç»™ç”¨æˆ·ï¼ˆå¦‚æœ parentCollectionId == 0ï¼‰
   - æˆ–é“¸é€ çˆ¶ä½ç½®ä»£å¸

##### 5. redeemPositions - èµå›ä½ç½®

```solidity
function redeemPositions(
    IERC20 collateralToken,
    bytes32 parentCollectionId,
    bytes32 conditionId,
    uint[] calldata indexSets
) external
```

**åŠŸèƒ½**ï¼šæ¡ä»¶è§£å†³åï¼Œèµå›ä½ç½®æ¢å–æŠµæŠ¼å“

**è®¡ç®—å…¬å¼**ï¼š
```
payout = balance * payoutNumerator / payoutDenominator
```

**ç¤ºä¾‹**ï¼š
- æŒæœ‰ 100 ä¸ª"ç»“æœA"ä»£å¸
- æ”¯ä»˜å‘é‡ï¼š[0.5, 0.5, 0] â†’ åˆ†å­ [1, 1, 0]ï¼Œåˆ†æ¯ 2
- èµå›é‡‘é¢ï¼š100 * 1 / 2 = 50 DAI

---

## ä½¿ç”¨æµç¨‹

### å®Œæ•´ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹

#### åœºæ™¯ï¼šåˆ›å»ºä¸€ä¸ªè¶³çƒæ¯”èµ›é¢„æµ‹å¸‚åœº

**é—®é¢˜**ï¼š"2024å¹´å†³èµ›è°ä¼šèµ¢ï¼Ÿ"
**ç»“æœ**ï¼š[é˜Ÿä¼A, é˜Ÿä¼B, å¹³å±€]
**æŠµæŠ¼å“**ï¼šDAI

#### æ­¥éª¤ 1ï¼šå‡†å¤‡æ¡ä»¶

```javascript
const oracle = "0x1234...";  // é¢„è¨€æœºåœ°å€
const questionId = web3.utils.randomHex(32);
const outcomeSlotCount = 3;  // 3ä¸ªå¯èƒ½ç»“æœ

await conditionalTokens.prepareCondition(
    oracle,
    questionId,
    outcomeSlotCount
);

const conditionId = getConditionId(oracle, questionId, outcomeSlotCount);
```

#### æ­¥éª¤ 2ï¼šåˆ†å‰²æŠµæŠ¼å“åˆ›å»ºä½ç½®

```javascript
// ç”¨æˆ·éœ€è¦å…ˆæˆæƒ ConditionalTokens åˆçº¦ä½¿ç”¨ DAI
await dai.approve(conditionalTokens.address, amount);

// åˆ†å‰²æˆä¸‰ä¸ªä½ç½®ï¼šé˜Ÿä¼Aã€é˜Ÿä¼Bã€å¹³å±€
const partition = [
    0b001,  // é˜Ÿä¼A (1)
    0b010,  // é˜Ÿä¼B (2)
    0b100   // å¹³å±€ (4)
];

await conditionalTokens.splitPosition(
    dai.address,
    "0x0000000000000000000000000000000000000000000000000000000000000000",
    conditionId,
    partition,
    web3.utils.toWei("100", "ether")  // 100 DAI
);
```

**ç»“æœ**ï¼šç”¨æˆ·è·å¾— 100 ä¸ªæ¯ç§ç»“æœçš„ä»£å¸

#### æ­¥éª¤ 3ï¼šäº¤æ˜“ä½ç½®ä»£å¸

ç”¨æˆ·å¯ä»¥åœ¨å¸‚åœºä¸Šäº¤æ˜“è¿™äº›ä½ç½®ä»£å¸ï¼š

```javascript
// è·å–ä½ç½®ID
const positionIdA = getPositionId(
    dai.address,
    getCollectionId("0x00...00", conditionId, 0b001)
);

// è½¬ç§»ä»£å¸ï¼ˆERC1155ï¼‰
await conditionalTokens.safeTransferFrom(
    seller,
    buyer,
    positionIdA,
    amount,
    "0x"
);
```

#### æ­¥éª¤ 4ï¼šé¢„è¨€æœºæŠ¥å‘Šç»“æœ

```javascript
// æ¯”èµ›ç»“æŸï¼Œé˜Ÿä¼Aèµ¢äº†
const payouts = [1, 0, 0];  // é˜Ÿä¼Aè·èƒœ

await conditionalTokens.reportPayouts(
    questionId,
    payouts,
    { from: oracle }
);
```

#### æ­¥éª¤ 5ï¼šèµå›ä½ç½®

```javascript
// æŒæœ‰"é˜Ÿä¼A"ä»£å¸çš„ç”¨æˆ·èµå›
const indexSets = [0b001];  // é˜Ÿä¼A

await conditionalTokens.redeemPositions(
    dai.address,
    "0x0000000000000000000000000000000000000000000000000000000000000000",
    conditionId,
    indexSets
);

// ç”¨æˆ·æ”¶åˆ° 100 DAIï¼ˆ1:1 èµå›ï¼‰
```

---

## ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåˆ›å»ºç®€å•çš„äºŒå…ƒé¢„æµ‹å¸‚åœº

```javascript
const ConditionalTokens = artifacts.require("ConditionalTokens");
const ERC20 = artifacts.require("MockCoin");

// éƒ¨ç½²åˆçº¦
const ct = await ConditionalTokens.new();
const dai = await ERC20.new();

// å‡†å¤‡æ¡ä»¶ï¼š"æ˜å¤©ä¼šä¸‹é›¨å—ï¼Ÿ"
const oracle = accounts[0];
const questionId = web3.utils.keccak256("will_it_rain_tomorrow");
const outcomeSlotCount = 2;  // [æ˜¯, å¦]

await ct.prepareCondition(oracle, questionId, outcomeSlotCount);
const conditionId = web3.utils.soliditySha3(
    { t: 'address', v: oracle },
    { t: 'bytes32', v: questionId },
    { t: 'uint', v: outcomeSlotCount }
);

// ç”¨æˆ·åˆ†å‰² 1000 DAI
await dai.mint(user, web3.utils.toWei("1000"));
await dai.approve(ct.address, web3.utils.toWei("1000"), { from: user });

await ct.splitPosition(
    dai.address,
    "0x" + "0".repeat(64),
    conditionId,
    [0b01, 0b10],  // [æ˜¯, å¦]
    web3.utils.toWei("1000"),
    { from: user }
);

// é¢„è¨€æœºæŠ¥å‘Šï¼šä¸‹é›¨äº†
await ct.reportPayouts(questionId, [1, 0], { from: oracle });

// èµå›
await ct.redeemPositions(
    dai.address,
    "0x" + "0".repeat(64),
    conditionId,
    [0b01],
    { from: user }
);
```

### ç¤ºä¾‹ 2ï¼šåµŒå¥—æ¡ä»¶

```javascript
// æ¡ä»¶1ï¼š"é˜Ÿä¼Aä¼šè¿›å…¥å†³èµ›å—ï¼Ÿ"
const condition1Id = await prepareCondition(oracle, questionId1, 2);

// æ¡ä»¶2ï¼š"å¦‚æœé˜Ÿä¼Aè¿›å…¥å†³èµ›ï¼Œä»–ä»¬ä¼šèµ¢å—ï¼Ÿ"
const condition2Id = await prepareCondition(oracle, questionId2, 2);

// ä»æŠµæŠ¼å“åˆ†å‰²æ¡ä»¶1
await ct.splitPosition(
    dai.address,
    NULL_BYTES32,
    condition1Id,
    [0b01, 0b10],  // [è¿›å…¥, æœªè¿›å…¥]
    amount
);

// è·å–"é˜Ÿä¼Aè¿›å…¥å†³èµ›"çš„é›†åˆID
const collection1 = getCollectionId(NULL_BYTES32, condition1Id, 0b01);

// åœ¨æ¡ä»¶1çš„åŸºç¡€ä¸Šåˆ†å‰²æ¡ä»¶2
await ct.splitPosition(
    dai.address,
    collection1,  // çˆ¶é›†åˆ
    condition2Id,
    [0b01, 0b10],  // [èµ¢, è¾“]
    amount
);

// ç°åœ¨æœ‰äº†åµŒå¥—ä½ç½®ï¼š"é˜Ÿä¼Aè¿›å…¥å†³èµ› ä¸” èµ¢å¾—å† å†›"
```

---

## å¼€å‘ç¯å¢ƒæ­å»º

### å‰ç½®è¦æ±‚

- Node.js >= 12.x
- npm æˆ– yarn
- Truffle
- Ganacheï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰

### å®‰è£…æ­¥éª¤

#### 1. å…‹éš†ä»“åº“

```bash
git clone https://github.com/gnosis/conditional-tokens-contracts.git
cd conditional-tokens-contracts
```

#### 2. å®‰è£…ä¾èµ–

```bash
npm install
# æˆ–
yarn install
```

#### 3. ç¼–è¯‘åˆçº¦

```bash
npm run compile
# æˆ–
truffle compile
```

#### 4. è¿è¡Œæµ‹è¯•

```bash
npm test
# æˆ–
truffle test
```

#### 5. éƒ¨ç½²åˆ°æœ¬åœ°ç½‘ç»œ

```bash
# å¯åŠ¨ Ganache
ganache-cli

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯éƒ¨ç½²
truffle migrate --network development
```

### é¡¹ç›®è„šæœ¬

```json
{
  "compile": "truffle compile",           // ç¼–è¯‘åˆçº¦
  "test": "truffle test",                 // è¿è¡Œæµ‹è¯•
  "migrate": "truffle migrate",           // éƒ¨ç½²åˆçº¦
  "lint": "eslint .",                     // ä»£ç æ£€æŸ¥
  "lint-contracts": "solium -d contracts/" // åˆçº¦ä»£ç æ£€æŸ¥
}
```

---

## é«˜çº§ä¸»é¢˜

### 1. CTHelpers åº“è¯¦è§£

`CTHelpers.sol` æä¾›äº†ä¸‰ä¸ªæ ¸å¿ƒè¾…åŠ©å‡½æ•°ï¼š

#### getConditionId

```solidity
function getConditionId(
    address oracle,
    bytes32 questionId,
    uint outcomeSlotCount
) internal pure returns (bytes32)
```

**å®ç°**ï¼š
```solidity
return keccak256(abi.encodePacked(oracle, questionId, outcomeSlotCount));
```

#### getCollectionId

```solidity
function getCollectionId(
    bytes32 parentCollectionId,
    bytes32 conditionId,
    uint indexSet
) internal view returns (bytes32)
```

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨æ¤­åœ†æ›²çº¿ç‚¹åŠ æ³•ï¼ˆEC point additionï¼‰
- æ”¯æŒåµŒå¥—æ¡ä»¶çš„ç»„åˆ
- ä½¿ç”¨ BN254 æ›²çº¿ï¼ˆalt_bn128ï¼‰

#### getPositionId

```solidity
function getPositionId(
    IERC20 collateralToken,
    bytes32 collectionId
) internal pure returns (uint)
```

**å®ç°**ï¼š
```solidity
return uint(keccak256(abi.encodePacked(collateralToken, collectionId)));
```

### 2. ä½æ©ç æ“ä½œè¯¦è§£

#### æ£€æŸ¥åˆ†åŒºæ˜¯å¦äº’ä¸ç›¸äº¤

```solidity
uint freeIndexSet = fullIndexSet;  // ä¾‹å¦‚ï¼š0b1111ï¼ˆ4ä¸ªç»“æœï¼‰

for (uint i = 0; i < partition.length; i++) {
    uint indexSet = partition[i];

    // æ£€æŸ¥ indexSet æ˜¯å¦æ˜¯ freeIndexSet çš„å­é›†
    require((indexSet & freeIndexSet) == indexSet, "partition not disjoint");

    // ä» freeIndexSet ä¸­ç§»é™¤ indexSet
    freeIndexSet ^= indexSet;
}
```

**ç¤ºä¾‹**ï¼š
```
fullIndexSet = 0b1111 (15)
partition = [0b0011, 0b1100]  // [3, 12]

ç¬¬ä¸€æ¬¡å¾ªç¯ï¼š
  indexSet = 0b0011
  (0b0011 & 0b1111) == 0b0011 âœ“
  freeIndexSet = 0b1111 ^ 0b0011 = 0b1100

ç¬¬äºŒæ¬¡å¾ªç¯ï¼š
  indexSet = 0b1100
  (0b1100 & 0b1100) == 0b1100 âœ“
  freeIndexSet = 0b1100 ^ 0b1100 = 0b0000

freeIndexSet == 0 â†’ å®Œæ•´åˆ†åŒº
```

#### è®¡ç®—æ”¯ä»˜åˆ†å­

```solidity
uint payoutNumerator = 0;
for (uint j = 0; j < outcomeSlotCount; j++) {
    if (indexSet & (1 << j) != 0) {
        payoutNumerator += payoutNumerators[conditionId][j];
    }
}
```

**ç¤ºä¾‹**ï¼š
```
indexSet = 0b0101 (ç»“æœ 0 å’Œ 2)
payoutNumerators = [1, 0, 2, 0]

j=0: 0b0101 & 0b0001 != 0 â†’ payoutNumerator += 1
j=1: 0b0101 & 0b0010 == 0 â†’ è·³è¿‡
j=2: 0b0101 & 0b0100 != 0 â†’ payoutNumerator += 2
j=3: 0b0101 & 0b1000 == 0 â†’ è·³è¿‡

payoutNumerator = 3
```

### 3. ERC1155 é›†æˆ

ConditionalTokens ç»§æ‰¿è‡ª ERC1155ï¼Œæ¯ä¸ªä½ç½®éƒ½æ˜¯ä¸€ä¸ª ERC1155 ä»£å¸ã€‚

#### æŸ¥è¯¢ä½™é¢

```javascript
const balance = await conditionalTokens.balanceOf(user, positionId);
```

#### æ‰¹é‡æŸ¥è¯¢

```javascript
const balances = await conditionalTokens.balanceOfBatch(
    [user1, user2, user3],
    [positionId1, positionId2, positionId3]
);
```

#### æˆæƒæ“ä½œå‘˜

```javascript
await conditionalTokens.setApprovalForAll(operator, true, { from: user });
```

#### è½¬ç§»ä»£å¸

```javascript
await conditionalTokens.safeTransferFrom(
    from,
    to,
    positionId,
    amount,
    "0x",
    { from: from }
);
```

---

## å¸¸è§é—®é¢˜ (FAQ)

### Q1: ä¸ºä»€ä¹ˆä½¿ç”¨ ERC1155 è€Œä¸æ˜¯ ERC20ï¼Ÿ

**A**: ERC1155 å…è®¸åœ¨å•ä¸ªåˆçº¦ä¸­ç®¡ç†å¤šç§ä»£å¸ç±»å‹ï¼Œå¤§å¤§é™ä½äº† gas æˆæœ¬ã€‚ä¸€ä¸ªæ¡ä»¶å¯èƒ½æœ‰æ•°ç™¾ä¸ªä¸åŒçš„ä½ç½®ç»„åˆï¼Œä½¿ç”¨ ERC1155 åªéœ€è¦ä¸€ä¸ªåˆçº¦ã€‚

### Q2: æœ€å¤šå¯ä»¥æœ‰å¤šå°‘ä¸ªç»“æœï¼Ÿ

**A**: æœ€å¤š 256 ä¸ªç»“æœï¼Œå› ä¸ºä½¿ç”¨ uint256 ä½æ©ç è¡¨ç¤ºç»“æœé›†åˆã€‚

### Q3: å¯ä»¥åœ¨æ¡ä»¶è§£å†³å‰åˆå¹¶ä½ç½®å—ï¼Ÿ

**A**: å¯ä»¥ï¼åˆå¹¶æ“ä½œä¸éœ€è¦æ¡ä»¶å·²è§£å†³ï¼Œè¿™å…è®¸ç”¨æˆ·åœ¨é¢„è¨€æœºæŠ¥å‘Šå‰é€€å‡ºå¸‚åœºã€‚

### Q4: å¦‚æœé¢„è¨€æœºæŠ¥å‘Šé”™è¯¯ç»“æœæ€ä¹ˆåŠï¼Ÿ

**A**: åˆçº¦æœ¬èº«ä¸æä¾›äº‰è®®è§£å†³æœºåˆ¶ã€‚å»ºè®®ä½¿ç”¨åƒ Reality.eth è¿™æ ·çš„å»ä¸­å¿ƒåŒ–é¢„è¨€æœºï¼Œå®ƒä»¬æœ‰å†…ç½®çš„äº‰è®®è§£å†³æµç¨‹ã€‚

### Q5: æ”¯ä»˜å‘é‡å¯ä»¥æ˜¯å°æ•°å—ï¼Ÿ

**A**: Solidity ä¸æ”¯æŒå°æ•°ï¼Œæ‰€ä»¥ä½¿ç”¨åˆ†æ•°è¡¨ç¤ºã€‚ä¾‹å¦‚ [1, 1, 0] åˆ†æ¯ä¸º 2 è¡¨ç¤º [0.5, 0.5, 0]ã€‚

### Q6: å¯ä»¥éƒ¨åˆ†èµå›ä½ç½®å—ï¼Ÿ

**A**: å¯ä»¥ï¼`redeemPositions` ä¼šèµå›ç”¨æˆ·æŒæœ‰çš„æ‰€æœ‰æŒ‡å®šä½ç½®ä»£å¸ï¼Œå¦‚æœåªæƒ³èµå›ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥å…ˆè½¬ç§»ä¸€éƒ¨åˆ†åˆ°å¦ä¸€ä¸ªåœ°å€ã€‚

### Q7: åµŒå¥—æ¡ä»¶æœ‰æ·±åº¦é™åˆ¶å—ï¼Ÿ

**A**: ç†è®ºä¸Šæ²¡æœ‰é™åˆ¶ï¼Œä½†æ¯å±‚åµŒå¥—éƒ½ä¼šå¢åŠ  gas æˆæœ¬ã€‚å®é™…åº”ç”¨ä¸­å»ºè®®ä¸è¶…è¿‡ 3-4 å±‚ã€‚

---

## å®é™…åº”ç”¨æ¡ˆä¾‹

### 1. Gnosis Prediction Markets

Gnosis ä½¿ç”¨ Conditional Tokens æ„å»ºäº†å»ä¸­å¿ƒåŒ–é¢„æµ‹å¸‚åœºå¹³å°ã€‚

**ç‰¹ç‚¹**ï¼š
- æ”¯æŒä»»æ„äº‹ä»¶é¢„æµ‹
- ä¸ Reality.eth é›†æˆä½œä¸ºé¢„è¨€æœº
- è‡ªåŠ¨åšå¸‚å•†ï¼ˆAMMï¼‰æä¾›æµåŠ¨æ€§

### 2. Polymarket

è™½ç„¶ Polymarket ä½¿ç”¨äº†ç±»ä¼¼çš„æ¦‚å¿µï¼Œä½†åœ¨ Polygon ä¸Šå®ç°ã€‚

### 3. Omen

åŸºäº Conditional Tokens çš„é¢„æµ‹å¸‚åœºå¹³å°ï¼Œè¿è¡Œåœ¨ xDai é“¾ä¸Šã€‚

**ç½‘å€**: https://omen.eth.link

---

## å®‰å…¨è€ƒè™‘

### 1. é¢„è¨€æœºä¿¡ä»»

âš ï¸ **å…³é”®é£é™©**ï¼šé¢„è¨€æœºå¯ä»¥æŠ¥å‘Šä»»æ„ç»“æœ

**ç¼“è§£æªæ–½**ï¼š
- ä½¿ç”¨å»ä¸­å¿ƒåŒ–é¢„è¨€æœºï¼ˆå¦‚ Reality.ethï¼‰
- å¤šç­¾é¢„è¨€æœº
- æ—¶é—´é”å®šæœºåˆ¶

### 2. é‡å…¥æ”»å‡»

âœ… **å·²é˜²æŠ¤**ï¼šåˆçº¦éµå¾ª Checks-Effects-Interactions æ¨¡å¼

### 3. æ•´æ•°æº¢å‡º

âœ… **å·²é˜²æŠ¤**ï¼šä½¿ç”¨ OpenZeppelin çš„ SafeMath åº“

### 4. å‰ç«¯è¿è¡Œ

âš ï¸ **é£é™©**ï¼šäº¤æ˜“å¯èƒ½è¢«æŠ¢å…ˆæ‰§è¡Œ

**ç¼“è§£æªæ–½**ï¼š
- ä½¿ç”¨ç§æœ‰äº¤æ˜“æ± 
- è®¾ç½®æ»‘ç‚¹ä¿æŠ¤

---

## éƒ¨ç½²ä¿¡æ¯

### ä¸»ç½‘éƒ¨ç½²

- **Ethereum Mainnet**: `0xC59b0e4De5F1248C1140964E0fF287B192407E0C`
- **xDai**: `0xCeAfDD6bc0bEF976fdCd1112955828E00543c0Ce`
- **Rinkeby (æµ‹è¯•ç½‘)**: `0x36bede640D19981A82090519bC1626249984c908`

### éªŒè¯åˆçº¦

æ‰€æœ‰éƒ¨ç½²çš„åˆçº¦éƒ½åœ¨ Etherscan ä¸ŠéªŒè¯ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹æºä»£ç ã€‚

---

## èµ„æºé“¾æ¥

### å®˜æ–¹èµ„æº

- **GitHub**: https://github.com/gnosis/conditional-tokens-contracts
- **æ–‡æ¡£**: https://docs.gnosis.io/conditionaltokens/
- **å®¡è®¡æŠ¥å‘Š**: æŸ¥çœ‹ `docs/audit/` ç›®å½•

### ç›¸å…³é¡¹ç›®

- **Gnosis Safe**: https://gnosis-safe.io/
- **Reality.eth**: https://reality.eth.link/
- **Omen**: https://omen.eth.link

### å­¦ä¹ èµ„æº

- **ERC1155 æ ‡å‡†**: https://eips.ethereum.org/EIPS/eip-1155
- **é¢„æµ‹å¸‚åœºç†è®º**: https://en.wikipedia.org/wiki/Prediction_market

---

## è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ï¼è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. Fork ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/amazing-feature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add amazing feature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/amazing-feature`)
5. å¼€å¯ Pull Request

### ä»£ç è§„èŒƒ

- ä½¿ç”¨ ESLint æ£€æŸ¥ JavaScript ä»£ç 
- ä½¿ç”¨ Solium æ£€æŸ¥ Solidity ä»£ç 
- æ‰€æœ‰æµ‹è¯•å¿…é¡»é€šè¿‡
- æ·»åŠ é€‚å½“çš„æ³¨é‡Š

---

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ **LGPL-3.0** è®¸å¯è¯ã€‚

âš ï¸ **å…è´£å£°æ˜**ï¼šæœ¬è½¯ä»¶æŒ‰"åŸæ ·"æä¾›ï¼Œä¸æä¾›ä»»ä½•å½¢å¼çš„ä¿è¯ã€‚

---

## æ€»ç»“

Conditional Tokens æ˜¯ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„ç³»ç»Ÿï¼Œç”¨äºåˆ›å»ºåŸºäºäº‹ä»¶ç»“æœçš„ä»£å¸åŒ–æƒç›Šã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
âœ… å»ä¸­å¿ƒåŒ–å’Œæ— éœ€è®¸å¯
âœ… æ”¯æŒå¤æ‚çš„æ¡ä»¶ç»„åˆ
âœ… é«˜æ•ˆçš„ ERC1155 å®ç°
âœ… ç»è¿‡å®¡è®¡çš„å®‰å…¨ä»£ç 

**é€‚ç”¨åœºæ™¯**ï¼š
- é¢„æµ‹å¸‚åœº
- ä¿é™©äº§å“
- æ¡ä»¶æ”¯ä»˜
- ä¿¡æ¯å¸‚åœº

**ä¸‹ä¸€æ­¥**ï¼š
1. è¿è¡Œæµ‹è¯•äº†è§£åˆçº¦è¡Œä¸º
2. é˜…è¯» `test/test-conditional-tokens.js` æŸ¥çœ‹å®Œæ•´ç¤ºä¾‹
3. å°è¯•åœ¨æµ‹è¯•ç½‘éƒ¨ç½²è‡ªå·±çš„æ¡ä»¶
4. æ¢ç´¢ä¸å…¶ä»– DeFi åè®®çš„é›†æˆ

---

**ç¼–å†™æ—¥æœŸ**: 2026-01-27
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆçº¦ç‰ˆæœ¬**: 1.0.3

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æäº¤ Issueï¼ğŸš€


